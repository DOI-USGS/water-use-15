info:
  id: water-use-15
  name: U.S. Water Use from 1950 to 2015.
  date: 2018-01-18
  publish-date:
  path: /water-use-15
  analytics-id:
  description: >-
    Data visualization of water use from 1950 - 2015.
  keywords:
  audience:
  url:
  thumbnail:
  required-packages:
    vizlab:
      repo: github
      version: 0.3.0
      name: USGS-VIZLAB/vizlab
      ref: NA
    aws.s3:
      repo: CRAN
      version: 0.3.3
    aws.signature:
      repo: CRAN
      version: 0.3.5
    dataRetrieval:
      repo: CRAN
      version: 2.7.4
    geojsonio:
      repo: CRAN
      version: 0.5.0
    jsonlite:
      repo: CRAN
      version: 1.5
    maps:
      repo: CRAN
      version: 3.2.0
    maptools:
      repo: CRAN
      version: 0.9-2
    readxl:
      repo: CRAN
      version: 1.0.0
    rgdal:
      repo: CRAN
      version: 1.2-16
    rgeos:
      repo: CRAN
      version: 0.3-26
    sp:
      repo: CRAN
      version: 1.2.6
    sf:
      repo: CRAN
      version: 0.5.4
      
  contributors:
    -
      name: Lindsay Carr
      email: lcarr@usgs.gov
      affiliation: U.S. Geological Survey
    -
      name: Alison Appling
      email: aappling@usgs.gov
      affiliation: U.S. Geological Survey

parameter:
  -
    id: spatial_metadata
    crs: '+init=epsg:4326' # works with d3.geoAlbers
    bbox: [-125, 26, -68, 50] # conus bbox
  -
    id: wu_type_column_names
    orig_names: ["TO-Wtotl", "PT-Wtotl", "PS-Wtotl", "IR-WFrTo", "IN-Wtotl"]
    new_names: ["total", "thermoelectric", "publicsupply", "irrigation", "industrial"]

fetch:
  -
    id: viewbox
    location: cache/viewbox.rds
    reader: rds
    fetcher: viewbox_limits
    scripts: [scripts/fetch/viewbox_limits.R , scripts/fetch/utils.R]
    depends:
      spatial_metadata: spatial_metadata
    comment: sets up the basic view window and projection
  -
    id: state_boundaries
    location: cache/state_boundaries.rds
    reader: rds
    fetcher: state_boundaries
    fetch_args:
      database: state
    scripts: [scripts/fetch/state_boundaries.R , scripts/fetch/utils.R]
    depends:
      viewbox: viewbox
      states_dict: states_dictionary
  -
    id: county_boundaries_census
    location: cache/county_boundaries_census.zip
    reader: shp
    fetcher: url
    remoteURL: 'http://www2.census.gov/geo/tiger/GENZ2015/shp/cb_2015_us_county_500k.zip'
    scripts: []
    # see https://www.census.gov/geo/maps-data/data/cbf/cbf_counties.html for details.
    # this file includes counties for places we don't need:
    #   Northern Mariana Island (STATEFP=='69'), Guam (STATEFP=='66'), and American Samoa (STATEFP=='60')
    # and also the places we do want:
    #   Virgin Islands, Puerto Rico, and all 50 states
  -
    id: county_boundaries_topojson
    location: cache/county_boundaries_topojson.zip
    fetch_args:
      object_name: "county_boundaries_topojson.zip"
      bucket_name: "viz-water-use-15"
    reader: zip
    mimetype: filepath
    fetcher: s3_object
    scripts: [scripts/fetch/s3_object.R]
  -
    id: wu_data_15
    location: cache/wu_data_15.xlsx
    fetch_args:
      object_name: "usco2015v2.0-dataviz.xlsx"
      bucket_name: "viz-water-use-15"
    reader: excel
    fetcher: s3_object
    scripts: [scripts/fetch/s3_object.R]

process:
  - 
    id: county_boundaries_topojson3
    location: cache/county_boundaries_USA.json
    depends:
      sp_object: county_boundaries_census
    process_args:
      script_file: scripts/process/simplify_topojson.sh
    processor: simplify_topojson
    scripts: scripts/process/simplify_topojson.R
    reader: json
    mimetype: application/json
  -
    id: state_boundaries_geojson
    location: cache/state_boundaries.geojson
    reader: json
    processor: sf_to_geojson
    scripts: [scripts/process/sf_to_geojson.R]
    depends:
      map_data: state_boundaries
    mimetype: application/geo+json
  -
    id: states_dictionary
    location: cache/states.json
    reader: json
    depends:
      zipfile: county_boundaries_topojson
    process_args:
      dict: states.json
    processor: extract_dict
    scripts: [scripts/process/extract_dict.R]
    mimetype: application/json
  -
    id: counties_dictionary
    location: cache/counties.json
    reader: json
    depends:
      zipfile: county_boundaries_topojson
    process_args:
      dict: counties.json
    processor: extract_dict
    scripts: [scripts/process/extract_dict.R]
    mimetype: application/json
  -
    id: county_centroids
    location: cache/county_centroids.rds
    reader: rds
    depends:
      sp_data: county_boundaries_census
    processor: compute_centroids
    scripts: scripts/process/compute_centroids.R
  -
    id: county_centroids_topojson
    location: cache/county_centroids.json
    reader: json
    depends:
      sp_object: county_centroids
    processor: sp_to_topojson
    scripts: scripts/process/sp_to_topojson.R
    mimetype: application/json
  -
    id: wu_data_15_simple
    location: cache/wu_data_15_simple.rds
    reader: rds
    depends:
      rawdata: wu_data_15
      col_names: wu_type_column_names
    processor: simplify_wu_data
    scripts: [scripts/process/simplify_wu_data.R]
  -
    id: wu_data_15_json
    location: cache/wu_data_15.json
    mimetype: application/json
    depends:
      wu_data_15_simple: wu_data_15_simple
    processor: json_wu_data
    scripts: [scripts/process/json_wu_data.R]
  -
    id: centroid_sizes
    location: cache/centroid_sizes.rds
    reader: rds
    depends:
      sp_data: county_centroids
      wu_data: wu_data_15_simple
      wu_type_names: wu_type_column_names
    processor: scale_values
    scripts: [scripts/process/scale_values.R]

visualize:
  -
    id: circle_map_total
    location: cache/circle_map_total.png
    depends:
      sp_circles: centroid_sizes
    visualize_args:
      wu_type: "total"
      crs: "+init=epsg:2163"
    visualizer: make_pie_map
    scripts: [scripts/visualize/make_circle_map.R]
  -
    id: circle_map_thermoelectric
    location: cache/circle_map_thermoelectric.png
    depends:
      sp_circles: centroid_sizes
    visualize_args:
      wu_type: "thermoelectric"
      crs: "+init=epsg:2163"
    visualizer: make_circle_map
    scripts: [scripts/visualize/make_circle_map.R]
  -
    id: circle_map_publicsupply
    location: cache/circle_map_publicsupply.png
    depends:
      sp_circles: centroid_sizes
    visualize_args:
      wu_type: "publicsupply"
      crs: "+init=epsg:2163"
    visualizer: make_circle_map
    scripts: [scripts/visualize/make_circle_map.R]
  -
    id: circle_map_irrigation
    location: cache/circle_map_irrigation.png
    depends:
      sp_circles: centroid_sizes
    visualize_args:
      wu_type: "irrigation"
      crs: "+init=epsg:2163"
    visualizer: make_circle_map
    scripts: [scripts/visualize/make_circle_map.R]
  -
    id: circle_map_industrial
    location: cache/circle_map_industrial.png
    depends:
      sp_circles: centroid_sizes
    visualize_args:
      wu_type: "industrial"
      crs: "+init=epsg:2163"
    visualizer: make_circle_map
    scripts: [scripts/visualize/make_circle_map.R]

publish:
  -
    id: wateruse_page
    name: index
    template: fullpage
    publisher: page
    depends:
      lib_d3_js: "lib-d3-js"
      topojson: "topojson"
      header_css: "lib-header-css"
      footer_css: "lib-footer-css"
      map_css: "map_css"
      header: "header_section"
      footer: "footer_section"
      hashes: "url_hashes"
      projection: "custom_projection"
      map_utils: "map_utils"
      map_counties: "map_counties"
      map: "build_map"
      state_boundaries_geojson: "state_boundaries_geojson"
      states_dictionary: "states_dictionary"
      counties_dictionary: "counties_dictionary"
      county_boundaries: "county_boundaries_topojson3"
      county_centroids: "county_centroids_topojson"
      wu_data_15_json: "wu_data_15_json"
    context:
      resources: ["lib_d3_js", "topojson", "header_css", "footer_css",
                  "map_css", "hashes", "projection", "map_utils", "map_counties"]
      sections: ["map"] # adding header and footer here, doubled each on the page
  -
    id: county_boundaries
    location: cache/county_boundaries
    reader: folder
    mimetype: filepath
    depends: 
      files_location: "county_boundaries_topojson"
    publish_args:
      pattern: "*-quantized.json"
    publisher: multiple_json_files
    scripts: scripts/publish/multiple_json_files.R
  -
    id: topojson
    location: "js/topojson.v1.min.js"
    mimetype: application/javascript
  -
    id: url_hashes
    location: "js/url_hashes.js"
    mimetype: application/javascript
  # custom_projection.js must be before build_map.js for it to find the projection function.
  -
    id: custom_projection
    location: "js/custom_projection.js"
    mimetype: application/javascript
  -
    id: build_map
    location: "js/build_map.js"
    mimetype: application/javascript
  -
    id: map_utils
    location: "js/map_utils.js"
    mimetype: application/javascript
  -
    id: map_counties
    location: "js/counties.js"
    mimetype: application/javascript
  -
    id: map_css
    location: "layout/css/map.css"
    mimetype: text/css
  -
    id: header_section
    template: header-template
    publisher: header
    depends: "lib-header-css"
    context:
      title: "Water use in the U.S. from 1950 to 2015"
  -
    id: footer_section
    template: footer-template
    publisher: footer
    depends: "lib-footer-css"
    blogsInFooter: FALSE
    vizzies:
      - name: Visualizing water use by region and time
        org: USGS-VIZLAB
        repo: water-use
